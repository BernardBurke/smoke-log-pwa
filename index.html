<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smoke Log</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #eee; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: #2d2d2d; padding: 20px; border-radius: 12px; width: 100%; max-width: 320px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #counter { font-size: 1.5rem; color: #ff4757; text-align: center; margin: 10px 0; font-weight: bold; }
        input[type="range"] { width: 100%; accent-color: #ff4757; margin: 15px 0; }
        textarea { width: 100%; box-sizing: border-box; background: #3d3d3d; color: white; border: 1px solid #444; padding: 10px; border-radius: 5px; height: 60px; font-size: 16px; }
        button { width: 100%; padding: 15px; margin-top: 15px; background: #ff4757; color: white; border: none; border-radius: 8px; font-weight: bold; }
        .log-item { background: #3d3d3d; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.85rem; border-left: 4px solid #ff4757; position: relative; }
        .log-time { color: #aaa; font-weight: bold; }
        .log-sat { float: right; color: #ff4757; font-weight: bold; }
        .log-comm { display: block; margin-top: 5px; color: #eee; font-style: italic; }
    </style>
</head>
<body onload="fetchHistory()">
    <div class="card">
        <h3>Daily Tally</h3>
        <div id="counter">--</div>
        <p style="text-align:center; font-size:0.8rem; color:#aaa;">Cigarettes in last 24h</p>
    </div>

    <div class="card">
        <h3>Log New</h3>
        <input type="range" id="satisfaction" min="1" max="5" value="3" oninput="document.getElementById('val').innerText = this.value">
        <div style="display:flex; justify-content:space-between; font-size: 0.8em;">
            <span>Satisfying</span> <b id="val">3</b> <span>Why bother?</span>
        </div>
        <textarea id="comment" placeholder="Context/Triggers..."></textarea>
        <button onclick="sendData()">Record Entry</button>
    </div>

    <div class="card">
        <h3>Recent History</h3>
        <div id="history-list">Loading logs...</div>
    </div>

    <script>
        const url = 'https://script.google.com/macros/s/AKfycbxoUmQBOFQuhIHmm_sN5PDqupbGXsCM-Zex1B7dE1bPH3CsU_wK3zhz_KqZty-RxW5f/exec';

        async function sendData() {
            const payload = {
                comment: document.getElementById('comment').value,
                satisfaction: document.getElementById('satisfaction').value
            };
            const btn = document.querySelector('button');
            btn.innerText = "Syncing...";
            
            await fetch(url, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            
            document.getElementById('comment').value = "";
            btn.innerText = "Record Entry";
            fetchHistory();
        }

        async function fetchHistory() {
            try {
                const response = await fetch(url);
                const logs = await response.json();
                const now = new Date();
                const dayAgo = now - (24 * 60 * 60 * 1000);
                
                const reversed = [...logs].reverse();
                let count = 0;
                let html = '';

                reversed.forEach((log, index) => {
                    const logDate = new Date(log[0]);
                    if (logDate > dayAgo) count++;
                    
                    if (index < 5) { // Show last 5
                        html += `<div class="log-item">
                            <span class="log-time">${logDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            <span class="log-sat">Rating: ${log[2]}</span>
                            <span class="log-comm">${log[1] || 'No comment'}</span>
                        </div>`;
                    }
                });

                document.getElementById('counter').innerText = count;
                document.getElementById('history-list').innerHTML = html || "No recent logs found.";
            } catch (e) {
                document.getElementById('history-list').innerText = "Sync Error.";
            }
        }
    </script>
</body>
</html>
